<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compressor Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #dashboard { text-align: center; }
        #historyModal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: black; text-decoration: none; }
        #chartContainer { width: 100%; height: 400px; margin-top: 20px; }
        #error { color: red; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; }
        input, label { margin: 5px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <div id="dashboard">
        <h1>Compressor Dashboard</h1>
        <p>View and download data from Google Sheet. Ensure the sheet is publicly accessible.</p>
        <button onclick="openModal()">View History</button>
    </div>

    <div id="historyModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>View History</h2>
            <label for="sheetName">Sheet Name:</label>
            <input type="text" id="sheetName" value="New_Compressor"><br>
            <label for="startDateTime">Start Date & Time:</label>
            <input type="datetime-local" id="startDateTime"><br>
            <label for="endDateTime">End Date & Time:</label>
            <input type="datetime-local" id="endDateTime"><br>
            <button onclick="viewData()">View</button>
            <button onclick="downloadData()">Download CSV</button>
            <div id="error"></div>
            <div id="chartContainer">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const spreadsheetId = '1fX9tLZg0IcLCzE0_mshodYJMAINiDdC0sXiUmo8Hr6U';

        function openModal() {
            document.getElementById('historyModal').style.display = 'block';
            document.getElementById('error').innerText = '';
        }

        function closeModal() {
            document.getElementById('historyModal').style.display = 'none';
            document.getElementById('error').innerText = '';
            if (window.myChart) window.myChart.destroy();
        }

        async function fetchSheetData(sheetName) {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch data: ${response.status}. Ensure the sheet is public and the sheet name is correct.`);
                }
                const text = await response.text();
                const json = JSON.parse(text.substring(47, text.length - 2));
                const rows = json.table.rows;
                const data = rows.map(row => row.c.map(cell => cell ? (cell.f || cell.v) : null));
                if (data.length === 0) {
                    throw new Error('No data found in the sheet.');
                }
                return data;
            } catch (error) {
                document.getElementById('error').innerText = error.message;
                console.error('Fetch error:', error);
                return [];
            }
        }

        function filterDataByDate(data, start, end) {
            return data.filter(row => {
                const dateStr = row[0];
                if (!dateStr) return false;
                const rowDate = new Date(dateStr);
                return (!start || rowDate >= start) && (!end || rowDate <= end);
            });
        }

        async function viewData() {
            const sheetName = document.getElementById('sheetName').value;
            const startInput = document.getElementById('startDateTime').value;
            const endInput = document.getElementById('endDateTime').value;
            const start = startInput ? new Date(startInput) : null;
            const end = endInput ? new Date(endInput) : null;

            document.getElementById('error').innerText = 'Fetching data...';
            const data = await fetchSheetData(sheetName);
            if (data.length === 0) return;

            const headers = data[0];
            const filteredData = filterDataByDate(data.slice(1), start, end);

            if (filteredData.length === 0) {
                document.getElementById('error').innerText = 'No data found for the selected date range.';
                return;
            }

            const labels = filteredData.map(row => row[0]);
            const voltage = filteredData.map(row => parseFloat(row[1]));
            const current = filteredData.map(row => parseFloat(row[8]));
            const energy = filteredData.map(row => parseFloat(row[16]));

            const ctx = document.getElementById('lineChart').getContext('2d');
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Average Voltage', data: voltage, borderColor: '#1e90ff', fill: false, tension: 0.1 },
                        { label: 'Average Current', data: current, borderColor: '#32cd32', fill: false, tension: 0.1 },
                        { label: 'Energy (kWh)', data: energy, borderColor: '#ff4500', fill: false, tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'minute' },
                            title: { display: true, text: 'Date & Time' }
                        },
                        y: { title: { display: true, text: 'Values' } }
                    }
                }
            });
            document.getElementById('error').innerText = '';
        }

        async function downloadData() {
            const sheetName = document.getElementById('sheetName').value;
            const startInput = document.getElementById('startDateTime').value;
            const endInput = document.getElementById('endDateTime').value;
            const start = startInput ? new Date(startInput) : null;
            const end = endInput ? new Date(endInput) : null;

            document.getElementById('error').innerText = 'Preparing download...';
            const data = await fetchSheetData(sheetName);
            if (data.length === 0) return;

            const filteredData = filterDataByDate(data, start, end);
            if (filteredData.length === 0) {
                document.getElementById('error').innerText = 'No data to download for the selected date range.';
                return;
            }

            const csvContent = ['Date & Time,Average Voltage,Average Current,Energy (kWh)', ...filteredData.map(row => [row[0], row[1], row[8], row[16]].join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${sheetName}_data.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            document.getElementById('error').innerText = '';
        }
    </script>
</body>
</html>
