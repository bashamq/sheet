<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compressor Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        #dashboard {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }
        #historyModal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover, .close:focus {
            color: #000;
            text-decoration: none;
        }
        #chartContainer {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
        #error {
            color: #d32f2f;
            margin: 10px 0;
            font-weight: bold;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        input, label {
            margin: 8px 0;
            display: block;
        }
        input[type="text"], input[type="datetime-local"] {
            padding: 8px;
            width: 100%;
            max-width: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        h1, h2 {
            color: #333;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <div id="dashboard">
        <h1>Compressor Dashboard</h1>
        <p>View and download data from Google Sheet via Apps Script (ID: AKfycbyejsErrNdce7tbi5K0da24BEjD1YJW1ciaIovDqdpOqNdBDFDlNUD91dArsF_AN0pY).</p>
        <button onclick="openModal()">View History</button>
    </div>

    <div id="historyModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>View History</h2>
            <label for="sheetName">Sheet Name:</label>
            <input type="text" id="sheetName" value="New_Compressor">
            <label for="startDateTime">Start Date & Time:</label>
            <input type="datetime-local" id="startDateTime">
            <label for="endDateTime">End Date & Time:</label>
            <input type="datetime-local" id="endDateTime">
            <button onclick="viewData()">View</button>
            <button onclick="downloadData()">Download CSV</button>
            <div id="error"></div>
            <div id="chartContainer">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbyejsErrNdce7tbi5K0da24BEjD1YJW1ciaIovDqdpOqNdBDFDlNUD91dArsF_AN0pY/exec';

        function openModal() {
            document.getElementById('historyModal').style.display = 'block';
            document.getElementById('error').innerText = '';
        }

        function closeModal() {
            document.getElementById('historyModal').style.display = 'none';
            document.getElementById('error').innerText = '';
            if (window.myChart) window.myChart.destroy();
        }

        async function fetchSheetData(sheetName, start, end) {
            try {
                let url = `${appsScriptUrl}?sheetName=${encodeURIComponent(sheetName)}`;
                if (start) url += `&start=${encodeURIComponent(start.toISOString())}`;
                if (end) url += `&end=${encodeURIComponent(end.toISOString())}`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch data: HTTP ${response.status}. Ensure the Apps Script is deployed and accessible.`);
                }
                const data = await response.json();
                if (!data || !Array.isArray(data) || data.length <= 1) {
                    throw new Error('No data found in the sheet or sheet is empty.');
                }
                return data;
            } catch (error) {
                document.getElementById('error').innerText = error.message;
                console.error('Fetch error:', error);
                return [];
            }
        }

        function filterDataByDate(data, start, end) {
            return data.filter(row => {
                const dateStr = row[0];
                if (!dateStr) return false;
                const rowDate = new Date(dateStr);
                if (isNaN(rowDate)) return false; // Skip invalid dates
                return (!start || rowDate >= start) && (!end || rowDate <= end);
            });
        }

        async function viewData() {
            const sheetName = document.getElementById('sheetName').value.trim();
            const startInput = document.getElementById('startDateTime').value;
            const endInput = document.getElementById('endDateTime').value;
            const start = startInput ? new Date(startInput) : null;
            const end = endInput ? new Date(endInput) : null;

            if (!sheetName) {
                document.getElementById('error').innerText = 'Please enter a valid sheet name.';
                return;
            }

            document.getElementById('error').innerText = 'Fetching data...';
            const data = await fetchSheetData(sheetName, start, end);
            if (data.length === 0) return;

            const headers = data[0];
            const filteredData = filterDataByDate(data.slice(1), start, end);

            if (filteredData.length === 0) {
                document.getElementById('error').innerText = 'No data found for the selected date range.';
                return;
            }

            const labels = filteredData.map(row => row[0]);
            const voltage = filteredData.map(row => parseFloat(row[1]) || 0);
            const current = filteredData.map(row => parseFloat(row[8]) || 0);
            const energy = filteredData.map(row => parseFloat(row[16]) || 0);

            const ctx = document.getElementById('lineChart').getContext('2d');
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Average Voltage', data: voltage, borderColor: '#1e90ff', fill: false, tension: 0.1 },
                        { label: 'Average Current', data: current, borderColor: '#32cd32', fill: false, tension: 0.1 },
                        { label: 'Energy (kWh)', data: energy, borderColor: '#ff4500', fill: false, tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'minute', displayFormats: { minute: 'yyyy-MM-dd HH:mm' } },
                            title: { display: true, text: 'Date & Time' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Values' }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
            document.getElementById('error').innerText = '';
        }

        async function downloadData() {
            const sheetName = document.getElementById('sheetName').value.trim();
            const startInput = document.getElementById('startDateTime').value;
            const endInput = document.getElementById('endDateTime').value;
            const start = startInput ? new Date(startInput) : null;
            const end = endInput ? new Date(endInput) : null;

            if (!sheetName) {
                document.getElementById('error').innerText = 'Please enter a valid sheet name.';
                return;
            }

            document.getElementById('error').innerText = 'Preparing download...';
            const data = await fetchSheetData(sheetName, start, end);
            if (data.length === 0) return;

            const filteredData = filterDataByDate(data.slice(1), start, end);
            if (filteredData.length === 0) {
                document.getElementById('error').innerText = 'No data to download for the selected date range.';
                return;
            }

            const csvContent = [
                'Date & Time,Average Voltage,Average Current,Energy (kWh)',
                ...filteredData.map(row => [row[0], row[1], row[8], row[16]].map(val => `"${val || ''}"`).join(','))
            ].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${sheetName}_data.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            document.getElementById('error').innerText = '';
        }
    </script>
</body>
</html>
